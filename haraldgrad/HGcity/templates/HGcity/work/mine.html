{% extends 'HGcity/base.html' %}
{% load static %}
{% block content %}

<img src="{% static 'images/background_login.png' %}" alt="Свет" id="background-image-login">

<h1>Шахта</h1>
<p>Монеты: <span id="wallet">{{ user.wallet }}</span></p> <!-- Отображаем монеты пользователя -->

<div id="game">
    <canvas id="miningCanvas"></canvas> <!-- Канвас для графики -->
    <button id="mineButton" onclick="mine()">Шахтёрский труд</button> <!-- Кнопка для действия -->
</div>

<style>
#game {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
}

#mineButton {
    width: 200px;
    height: 60px;
    font-size: 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#mineButton:hover {
    background-color: #45a049;
}

canvas {
    width: 500px;
    height: 300px;
    background-color: #ececec;
}
</style>

<script>
// Функция для получения CSRF токена из cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

let clicks = 0; // Счётчик кликов

// Настроим канвас для визуализации
let canvas = document.getElementById("miningCanvas");
let ctx = canvas.getContext("2d");
canvas.width = 500;
canvas.height = 300;

function mine() {
    clicks++; // Увеличиваем счётчик кликов

    // Рисуем эффект на канвасе
    drawMiningEffect();

    // Обновляем количество монет на странице
    let wallet = document.getElementById("wallet");
    wallet.textContent = parseInt(wallet.textContent) + 1; // Увеличиваем на 1

    // Отправка данных на сервер с CSRF токеном
    fetch("/api/mine/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')  // Добавляем CSRF токен
        },
        body: JSON.stringify({})  // Пустое тело
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Ошибка на сервере: " + response.statusText);
        }
        return response.json();
    })
    .then(data => {
        if (data.wallet !== undefined) {
            // Обновляем кошелек на странице
            document.getElementById("wallet").textContent = data.wallet;
        } else {
            console.error("Ошибка: сервер не вернул правильный ответ.");
        }
    })
    .catch(error => {
        console.error("Ошибка при запросе на сервер:", error);
    });
}

// Функция рисования эффекта добычи
function drawMiningEffect() {
    ctx.clearRect(0, 0, canvas.width, canvas.height); // Очистим канвас
    ctx.fillStyle = "rgba(255, 223, 0, 0.8)"; // Цвет эффекта
    ctx.beginPath();
    ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 30, 0, Math.PI * 2, true);
    ctx.fill(); // Рисуем круг (эффект)

    // Можно добавить другие визуальные эффекты или анимацию
}

</script>

{% endblock %}

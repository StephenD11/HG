<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фабрика</title>
    <script>
        let clickCount = 0;
        let timer;
        let remainingTime = 6 * 60; // 6 минут в секундах
        let lastClickTime = 0;  // Время последнего клика

        // Функция для обновления таймера
        function updateTimer() {
            if (remainingTime <= 0) {
                clearInterval(timer);
                alert('Время вышло!');
            } else {
                remainingTime--;
                document.getElementById('timer').innerText = `Оставшееся время: ${remainingTime}s`;
            }
        }

        // Функция для обработки кликов
        function handleClick() {
            const currentTime = Date.now();

            // Разрешаем клик только если прошло 4 секунды с последнего клика
            if (currentTime - lastClickTime >= 4000) {
                clickCount++;
                lastClickTime = currentTime;  // Обновляем время последнего клика
                document.getElementById('clickCounter').innerText = `Клики: ${clickCount}`;
            }
        }

        // Функция для отправки данных на сервер
        function submitData() {
            fetch('{% url "HGcity:factory_view" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `clicks=${clickCount}`
            })
            .then(response => response.json())
            .then(data => {
                // Перенаправляем на страницу с результатами
                window.location.href = data.redirect_url;
            });
        }

        // Инициализация таймера при загрузке страницы
        window.onload = function() {
            timer = setInterval(updateTimer, 1000);

            // Слушаем сообщения от iframe
            window.addEventListener('message', function(event) {
                if (event.data === 'click') {
                    handleClick();
                }
            });
        };
    </script>
    <link rel="stylesheet" href="{% static 'HGcity/css/background.css' %}">
    <link rel="stylesheet" href="{% static 'HGcity/css/style.css' %}">
</head>
<body>
    <img src="{% static '/images/background_rules.png' %}" alt="Свет" id="background-image-rules">


<div class="div-factory">
    <h1>ЗАВОД ИМ.ПОТНОЙ НОГИ</h1>
    <div style="display: flex; width: 800px; height: 600px;">
        <iframe id="game-frame" src="{% static 'HGcity/game/index.html' %}" style="border: none; border-radius:15px;"  width="100%" height="75%"></iframe>
    </div>
    <p  id="timer" style="margin-top: -110px;">Оставшееся время: 360s</p>
    <button onclick="submitData()" >Завершить смену</button>
    {% if user.username == 'Хара2льд' %}
        <p id="clickCounter">Клики: 0</p>
    {% endif %}

</div>

</body>
</html>
